<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
<title>Boda WhyNot!?</title>

<style>
/* --- ESTILOS GENERALES --- */
:root {
  --bg-color: #fafafa;
  --card-bg: #ffffff;
  --text-main: #262626;
  --text-light: #8e8e8e;
  --border: #efefef;
  --accent: #c6a76b;
  --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

body {
  margin: 0;
  font-family: var(--font-stack);
  background: var(--bg-color);
  color: var(--text-main);
  padding-bottom: 90px;
}

/* --- LOGIN --- */
.login-overlay {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
  background-image: url("https://raw.githubusercontent.com/jcamosa/bodawhynot/main/header.jpg");
  background-size: cover;
  background-position: center;
}
.login-overlay::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
.login-box { position: relative; z-index: 2001; background: white; width: 85%; max-width: 320px; padding: 30px 20px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
.login-box h2 { margin-top: 0; font-family: "Georgia", serif; color: #333; }
.login-box p { font-size: 14px; color: #666; margin-bottom: 20px; }
.login-input { width: 100%; padding: 12px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; margin-bottom: 15px; text-align: center; }
.login-btn { width: 100%; padding: 12px; background: var(--text-main); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; }

/* --- HEADER --- */
.header { position: relative; height: 35vh; overflow: hidden; background-color: #333; background-image: url("https://raw.githubusercontent.com/jcamosa/bodawhynot/main/header.jpg"); background-size: cover; background-position: center; }
.header::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 60%, rgba(0,0,0,0.6)); }
.header-title { position: absolute; bottom: 20px; left: 20px; color: white; z-index: 2; text-shadow: 0 2px 10px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.2s; }
.header-title:active { transform: scale(0.95); }
.header-title h1 { font-weight: 300; margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
.header-title span { font-size: 36px; font-family: "Georgia", serif; font-style: italic; font-weight: 700; }
.current-user-tag { position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px); padding: 5px 10px; border-radius: 15px; color: white; font-size: 12px; font-weight: 600; z-index: 10; border: 1px solid rgba(255,255,255,0.3); cursor: pointer; }

/* --- STORIES --- */
.stories-title { padding: 15px 15px 5px; background: white; font-weight: 700; font-size: 14px; color: #c6a76b; text-transform: uppercase; letter-spacing: 1px; }
.stories-wrapper { background: #fff; border-bottom: 1px solid #efefef; padding: 10px 0 15px 15px; display: flex; overflow-x: auto; gap: 15px; scrollbar-width: none; }
.stories-wrapper::-webkit-scrollbar { display: none; } 
.story-item { display: flex; flex-direction: column; align-items: center; width: 74px; flex-shrink: 0; cursor: pointer; position: relative; }
.story-ring { width: 66px; height: 66px; border-radius: 50%; padding: 5px; display: flex; justify-content: center; align-items: center; }
.story-ring.gold { background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); box-shadow: 0 0 10px rgba(191, 149, 63, 0.5); }
.story-ring.silver { background: linear-gradient(45deg, #9c9c9c, #ffffff, #c0c0c0, #eaeaea, #7f7f7f); }
.story-ring.bronze { background: linear-gradient(45deg, #804a00, #dcb183, #cd7f32, #b06b28); }
.story-ring.black { background: linear-gradient(45deg, #444, #222); }
.story-img { width: 100%; height: 100%; border-radius: 50%; border: 3px solid white; object-fit: cover; background: #eee; }
.story-name { font-size: 11px; margin-top: 6px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; font-weight: 600; }

/* GALER√çA */
.gallery { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; padding-top: 10px; }
.profile-header-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #333; color: white; border-radius: 8px; margin: 0 10px; margin-top: -10px; animation: slideDown 0.3s ease; }
.profile-info h3 { margin: 0; font-size: 16px; }
.close-profile-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
@keyframes slideDown { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }

.card { background: var(--card-bg); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); display: flex; flex-direction: column; }
@media (min-width: 600px) { .card { border-radius: 8px; border: 1px solid #dbdbdb; } }
.card-header { padding: 10px 15px; display: flex; align-items: center; gap: 10px; }
.user-avatar-placeholder { width: 32px; height: 32px; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: bold; color: #777; cursor: pointer; }
.uploader-info { font-weight: 600; font-size: 14px; color: #262626; line-height: 1.2; cursor: pointer; }
.uploader-info:hover { text-decoration: underline; }
.upload-time { font-size: 11px; color: #a0a0a0; font-weight: 400; }

.card-media-container { width: 100%; background: #f4f4f4; min-height: 300px; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; }
.card-media-container img { width: 100%; height: auto; max-height: 600px; object-fit: contain; display: block; }
.big-heart { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); width: 120px; height: 120px; z-index: 20; pointer-events: none; animation: heartPop 1s ease-out forwards; }
.big-heart svg { width: 100%; height: 100%; filter: drop-shadow(0 4px 15px rgba(0,0,0,0.5)); }
@keyframes heartPop { 0% { transform: translate(-50%, -50%) scale(0); opacity: 1; } 15% { transform: translate(-50%, -50%) scale(1.2); } 30% { transform: translate(-50%, -50%) scale(1); } 70% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }

.actions { padding: 12px 16px 0; display: flex; justify-content: space-between; align-items: center; }
.action-buttons { display: flex; gap: 16px; }
.icon-btn { background: none; border: none; cursor: pointer; padding: 0; transition: opacity 0.2s, transform 0.1s; display: flex; align-items: center; justify-content: center; }
.icon-btn:active { transform: scale(1.2); }
.icon-btn svg { width: 26px; height: 26px; stroke: var(--text-main); stroke-width: 1.8; fill: none; }
.icon-btn.liked svg { fill: #ed4956; stroke: #ed4956; }
.likes-count { padding: 0 16px; font-weight: 600; font-size: 14px; margin-top: 8px; margin-bottom: 4px; }
.comments-section { padding: 0 16px 12px; }
.comment { font-size: 14px; margin-bottom: 4px; line-height: 1.4; display: flex; justify-content: space-between; align-items: flex-start; }
.comment-text { flex: 1; margin-right: 8px; }
.comment-time { font-size: 11px; color: #a0a0a0; white-space: nowrap; margin-top: 2px; }
.view-more-comments { color: #8e8e8e; font-size: 14px; margin-bottom: 8px; cursor: pointer; background: none; border: none; padding: 0; text-align: left; font-weight: 500; display: block; width: 100%; }
.hidden-comments { display: none; }
.add-comment-box { border-top: 1px solid var(--border); padding: 12px 16px; display: flex; align-items: center; gap: 10px; }
.comment-input { flex: 1; border: none; outline: none; font-size: 14px; background: transparent; padding: 8px 0; }
.post-btn { background: none; border: none; color: #0095f6; font-weight: 600; font-size: 14px; cursor: pointer; opacity: 0.5; padding: 0 8px; }
.comment-input:not(:placeholder-shown) + .post-btn { opacity: 1; }
.bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid var(--border); padding: 10px 20px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; gap: 15px; z-index: 90; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
.nav-item { flex: 1; }
.btn-primary, .btn-secondary { width: 100%; padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; text-align: center; border: none; display: flex; justify-content: center; align-items: center; gap: 8px; }
.btn-primary { background: var(--text-main); color: white; }
.btn-secondary { background: #f0f0f0; color: var(--text-main); }
input[type=file] { display: none; }
.toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: 500; z-index: 3100; opacity: 0; transition: opacity 0.3s, top 0.3s; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
.toast.show { opacity: 1; top: 40px; }

/* ========================================================= */
/* MODAL Y PRESENTACI√ìN (LA MAGIA EMPIEZA AQU√ç)              */
/* ========================================================= */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; justify-content: center; align-items: center; z-index: 100; overflow: hidden; padding: 0; box-sizing: border-box; cursor: pointer; }
.modal-content { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
.modal-card { background: white; width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; position: relative; max-height: 90vh; cursor: default; margin: 20px;}
.modal-card .card-media-container { background: #000; }
.modal-card .card-media-container img { max-height: 60vh; }
.modal-card .comments-section { overflow-y: auto; flex: 1; max-height: 200px; }
.modal img.simple-img { max-width: 100vw; max-height: 100vh; object-fit: contain; }

/* Wrapper Exclusivo Presentaci√≥n */
.slideshow-wrapper { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 50px 20px; box-sizing: border-box; overflow: hidden; }

/* Animaciones Creadas */
@keyframes fadeSlideIn { from { opacity: 0; transform: scale(1.05); } to { opacity: 1; transform: scale(1); } }
@keyframes textDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes textUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes infoPopLeft { from { opacity: 0; transform: translateX(-40px) scale(0.9); } to { opacity: 1; transform: translateX(0) scale(1); } }

/* Componentes Slide Normal */
.slideshow-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; z-index: 1; animation: fadeSlideIn 1.5s ease-out forwards; }
.slideshow-brand-top { font-family: "Georgia", serif; font-size: 38px; font-style: italic; color: #fff; text-shadow: 0 4px 20px rgba(0,0,0,0.9); text-align: center; z-index: 10; animation: textDown 1.5s ease-out; }
.slideshow-brand-bottom { font-family: "Georgia", serif; font-size: 45px; font-weight: 700; color: var(--accent); text-shadow: 0 4px 20px rgba(0,0,0,0.9); text-align: center; z-index: 10; letter-spacing: 2px; animation: textUp 1.5s ease-out; }

/* P√≠ldora Elegante (Izquierda) */
.slideshow-info { position: absolute; bottom: 40px; left: 30px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 40px; color: white; display: flex; gap: 12px; align-items: center; font-size: 18px; font-weight: 600; box-shadow: 0 15px 35px rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); z-index: 10; animation: infoPopLeft 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; white-space: nowrap; }
.slideshow-info .icon-block { display: flex; align-items: center; gap: 8px; }
.slideshow-heart { width: 24px; height: 24px; fill: #ed4956; animation: beat 1s infinite; filter: drop-shadow(0 0 5px rgba(237,73,86,0.6)); }
.slideshow-info span { font-weight: 400; opacity: 0.9; margin-right: 5px;}
@keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

/* ========================================================= */
/* EL MOMENTO √ìSCAR: PANTALLA DE RANKING (TOP 3)             */
/* ========================================================= */
.ranking-wrapper { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%); z-index: 20; padding: 20px; text-align: center; }
.ranking-title { color: var(--accent); font-family: "Georgia", serif; font-size: 45px; font-weight: bold; margin-bottom: 50px; text-transform: uppercase; letter-spacing: 3px; animation: textDown 1s ease-out; text-shadow: 0 0 25px rgba(198,167,107,0.4); }
.podium { display: flex; align-items: flex-end; justify-content: center; gap: 20px; width: 100%; max-width: 800px; }
.podium-item { display: flex; flex-direction: column; align-items: center; animation: fadeSlideIn 1s ease-out forwards; opacity: 0; }
.podium-item.rank-2 { order: 1; animation-delay: 0.2s; }
.podium-item.rank-1 { order: 2; animation-delay: 0.6s; z-index: 5; margin-bottom: 40px; transform: scale(1.15); }
.podium-item.rank-3 { order: 3; animation-delay: 0.4s; }

.podium-ring { width: 140px; height: 140px; border-radius: 50%; padding: 8px; margin-bottom: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.8); }
.rank-1 .podium-ring { width: 180px; height: 180px; background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); box-shadow: 0 0 30px rgba(191,149,63,0.5); }
.rank-2 .podium-ring { background: linear-gradient(45deg, #9c9c9c, #ffffff, #c0c0c0, #eaeaea, #7f7f7f); }
.rank-3 .podium-ring { background: linear-gradient(45deg, #804a00, #dcb183, #cd7f32, #b06b28); }
.podium-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid #111; }

.podium-name { color: white; font-size: 18px; font-weight: 600; margin-bottom: 5px; text-shadow: 0 2px 5px #000; }
.rank-1 .podium-name { font-size: 24px; color: #fcf6ba; }
.podium-likes { display: flex; align-items: center; justify-content: center; gap: 5px; color: #ed4956; font-size: 22px; font-weight: bold; }
</style>
</head>

<body>

<div id="loginOverlay" class="login-overlay">
  <div class="login-box">
    <h2>¬°Bienvenido! üëã</h2>
    <p>Para participar en la competici√≥n de fotos de la boda, dinos qui√©n eres.</p>
    <input type="text" id="usernameInput" class="login-input" placeholder="Tu nombre..." autocomplete="off">
    <button class="login-btn" onclick="saveUser()">ENTRAR</button>
  </div>
</div>

<div class="header">
  <div class="current-user-tag" id="userTag" onclick="filterByUser(currentUser)">Invitado</div>
  <div class="header-title" onclick="resetGallery()">
    <h1>Boda</h1>
    <span>WhyNot!?</span>
  </div>
</div>

<div class="stories-title">üèÜ Top 5 - M√°s Votados</div>
<div id="stories" class="stories-wrapper"></div>

<div id="gallery" class="gallery">
  <p style="text-align:center; color:#999; margin-top:40px;">Cargando competici√≥n...</p>
</div>

<div id="toast" class="toast">¬°Foto subida correctamente! üéâ</div>

<div class="bottom-nav">
  <div class="nav-item">
    <button class="btn-secondary" onclick="startSlideshow()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
      Presentaci√≥n
    </button>
  </div>
  <div class="nav-item">
    <label class="btn-primary">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
        <circle cx="12" cy="13" r="4"></circle>
      </svg>
      Subir Foto
      <input type="file" id="file" accept="image/*">
    </label>
  </div>
</div>

<div id="modal" class="modal" onclick="closeModalDirect(event)">
  <div id="modal-content" class="modal-content"></div>
</div>

<script>
// --- CONFIGURACI√ìN ---
const API = "https://script.google.com/macros/s/AKfycbwNcTmXOA7IZHDcDB3v3R_c01KRdI4IyhAj52dOJ-KIxtphyaWSfBlNYnSnraRShsJ_/exec";

/* REFERENCIAS DOM */
const gallery = document.getElementById("gallery");
const storiesContainer = document.getElementById("stories");
const input = document.getElementById("file");
const modal = document.getElementById("modal");
const modalContent = document.getElementById("modal-content");
const toast = document.getElementById("toast");
const loginOverlay = document.getElementById("loginOverlay");
const usernameInput = document.getElementById("usernameInput");
const userTag = document.getElementById("userTag");

let itemsGlobal = [];
let slideInterval = null;
let isSlideshowActive = false;
let isFiltering = false; 
let currentUser = "";

// Variables Presentaci√≥n
let slideCounter = 0; 
let displayedCount = 0;
const ITEMS_PER_PAGE = 10;

function timeAgo(dateParam) {
  if (!dateParam) return "";
  const date = new Date(dateParam);
  const now = new Date();
  const seconds = Math.round((now - date) / 1000);
  const minutes = Math.round(seconds / 60);
  const hours = Math.round(minutes / 60);
  const days = Math.round(hours / 24);
  if (seconds < 60) return "ahora";
  if (minutes < 60) return `${minutes} min`;
  if (hours < 24) return `${hours} h`;
  if (days < 7) return `${days} d`;
  return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
}

function checkLogin() {
  try {
    const storedName = localStorage.getItem("whynot_user");
    if (storedName) { currentUser = storedName; userTag.textContent = currentUser; loginOverlay.style.display = "none"; } 
    else { loginOverlay.style.display = "flex"; }
  } catch (e) { loginOverlay.style.display = "flex"; }
}

function saveUser() {
  const name = usernameInput.value.trim();
  if (name.length < 2) return alert("Por favor, pon un nombre v√°lido.");
  const userExists = itemsGlobal.some(item => item.uploader && item.uploader.toLowerCase() === name.toLowerCase());
  if (userExists) { alert("‚ö†Ô∏è Ese nombre ya est√° en uso. Por favor, elige otro (ej: " + name + " G.)"); return; }
  try { localStorage.setItem("whynot_user", name); } catch (e) {}
  currentUser = name; userTag.textContent = currentUser; loginOverlay.style.display = "none";
  showToast("¬°Bienvenido " + name + "! üëã");
}

checkLogin();

const heartSVG = `<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
const shareSVG = `<svg viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>`;

function getOptimizedThumbnailUrl(originalUrl) {
    if (originalUrl && originalUrl.includes("id=")) {
        const id = originalUrl.split("id=")[1].split("&")[0];
        return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
    }
    return originalUrl;
}

// üí• MAGIA 1: Carga siempre la galer√≠a en background aunque est√© la presentaci√≥n puesta
async function loadGallery(silent = false){
  if(isFiltering && silent) return;
  try {
    const res = await fetch(API);
    let items = await res.json();
    items.sort((a, b) => b.id - a.id); 
    itemsGlobal = items; // Al actualizar esto, la ruleta de fotos coge las nuevas sola
    if(!silent) { renderStories(items); renderGallery(items, false); } 
    else { renderGallery(items, true); }
  } catch (error) { if(!silent) gallery.innerHTML = "<p style='text-align:center;'>Error de conexi√≥n.</p>"; }
}

function filterByUser(username) {
    if(!username) return;
    isFiltering = true; gallery.innerHTML = ""; 
    const header = document.createElement("div"); header.className = "profile-header-bar";
    header.innerHTML = `<div class="profile-info"><h3>üì∑ Fotos de ${username}</h3></div><button class="close-profile-btn" onclick="resetGallery()">‚úñ Ver todas</button>`;
    gallery.appendChild(header);

    const userItems = itemsGlobal.filter(i => i.uploader === username);
    if(userItems.length === 0) { gallery.innerHTML += "<p style='text-align:center; padding:20px; color:#999;'>Este usuario a√∫n no tiene fotos.</p>"; } 
    else {
        let myLikes = []; try { myLikes = JSON.parse(localStorage.getItem("whynot_likes") || "[]"); } catch(e) {}
        userItems.forEach(item => { if(item.url.includes("/vid.mp4")) return; const card = createCardElement(item, myLikes); gallery.appendChild(card); });
    }
    window.scrollTo({ top: 300, behavior: 'smooth' });
}

function resetGallery() { isFiltering = false; renderGallery(itemsGlobal, false); window.scrollTo({ top: 0, behavior: 'smooth' }); }

function renderStories(items) {
    storiesContainer.innerHTML = ""; const photos = items.filter(i => !i.url.includes("/vid.mp4"));
    const ranking = [...photos].sort((a, b) => b.likes - a.likes); const top5 = ranking.slice(0, 5);
    if(top5.length === 0) { document.querySelector('.stories-title').style.display = "none"; storiesContainer.style.display = "none"; return; }
    document.querySelector('.stories-title').style.display = "block"; storiesContainer.style.display = "flex";
    top5.forEach((item, index) => {
        const el = document.createElement("div"); el.className = "story-item"; el.onclick = () => openFullPost(item);
        let ringClass = index === 0 ? "gold" : index === 1 ? "silver" : index === 2 ? "bronze" : "black";
        el.innerHTML = `<div class="story-ring ${ringClass}"><img class="story-img" src="${getOptimizedThumbnailUrl(item.url)}" loading="lazy"></div><div class="story-name">${item.likes} pts</div>`;
        storiesContainer.appendChild(el);
    });
}

function renderGallery(items, isSilent = false) {
    if(isFiltering) return; 
    let myLikes = []; try { myLikes = JSON.parse(localStorage.getItem("whynot_likes") || "[]"); } catch(e) {}
    if (isSilent) { updateExistingCards(items, myLikes); return; }
    gallery.innerHTML = ""; displayedCount = 0;
    if(items.length === 0){ gallery.innerHTML = "<p style='text-align:center;padding:20px;'>S√© el primero en subir una foto üì∏</p>"; return; }
    renderNextBatch(items, myLikes);
}

function renderNextBatch(items = itemsGlobal, myLikes = null) {
    if (isFiltering) return; 
    if (!myLikes) { try { myLikes = JSON.parse(localStorage.getItem("whynot_likes") || "[]"); } catch(e) { myLikes = []; } }
    const batch = items.slice(displayedCount, displayedCount + ITEMS_PER_PAGE);
    if (batch.length === 0) return;
    batch.forEach(item => { if(item.url.includes("/vid.mp4")) return; const card = createCardElement(item, myLikes); gallery.appendChild(card); });
    displayedCount += batch.length;
}

function updateExistingCards(newItems, myLikes) {
    const existingCards = document.querySelectorAll('.card');
    const existingIds = Array.from(existingCards).map(c => parseInt(c.id.replace('post-', '')));
    const newPosts = newItems.filter(item => !existingIds.includes(item.id) && !item.url.includes("/vid.mp4"));
    if (newPosts.length > 0) {
        if(existingCards.length === 0) gallery.innerHTML = ""; 
        [...newPosts].reverse().forEach(item => { const card = createCardElement(item, myLikes); gallery.prepend(card); displayedCount++; });
    }
    newItems.forEach(item => {
        const likesCount = document.getElementById(`likes-${item.id}`);
        if (likesCount) { if (item.likes > 0) likesCount.textContent = `${item.likes} Me gusta`; else likesCount.textContent = "S√© el primero en dar Like"; }
    });
}

window.addEventListener('scroll', () => {
    if (isFiltering) return; 
    const scrollY = window.scrollY || document.documentElement.scrollTop;
    if ((window.innerHeight + scrollY) >= document.body.offsetHeight - 800) { if (displayedCount < itemsGlobal.length) { renderNextBatch(itemsGlobal); } }
});

function createCardElement(item, myLikes, isModal = false) {
      const card = document.createElement("div"); card.className = isModal ? "modal-card" : "card"; if (!isModal) card.id = `post-${item.id}`;
      const uploaderName = item.uploader || "Invitado"; const initial = uploaderName.charAt(0).toUpperCase(); const timeAgoStr = timeAgo(item.timestamp); 
      const headerDiv = document.createElement("div"); headerDiv.className = "card-header";
      headerDiv.innerHTML = `<div class="user-avatar-placeholder" onclick="filterByUser('${uploaderName}')">${initial}</div><div><div class="uploader-info" onclick="filterByUser('${uploaderName}')">${uploaderName}</div><span class="upload-time">${timeAgoStr}</span></div>`;
      card.appendChild(headerDiv);

      const mediaContainer = document.createElement("div"); mediaContainer.className = "card-media-container";
      const img = document.createElement("img"); img.src = isModal ? item.url : getOptimizedThumbnailUrl(item.url); img.loading = "lazy";
      mediaContainer.appendChild(img); card.appendChild(mediaContainer);

      const actions = document.createElement("div"); actions.className = "actions";
      const leftActions = document.createElement("div"); leftActions.className = "action-buttons";
      const alreadyLiked = myLikes.includes(item.id);
      const likeBtn = document.createElement("button"); likeBtn.className = "icon-btn" + (alreadyLiked ? " liked" : ""); likeBtn.innerHTML = heartSVG;
      const likeCountId = isModal ? `likes-modal-${item.id}` : `likes-${item.id}`;
      likeBtn.onclick = (e) => handleLike(e, item.id, likeCountId, mediaContainer);
      if(!isModal) { mediaContainer.ondblclick = () => { if(!likeBtn.classList.contains("liked")) { likeBtn.click(); } else { showBigHeart(mediaContainer); } }; }

      const shareBtn = document.createElement("button"); shareBtn.className = "icon-btn"; shareBtn.innerHTML = shareSVG;
      shareBtn.onclick = (e) => shareImage(e, item.url); 
      leftActions.appendChild(likeBtn); leftActions.appendChild(shareBtn); actions.appendChild(leftActions); card.appendChild(actions);

      const likesCount = document.createElement("div"); likesCount.className = "likes-count"; likesCount.id = likeCountId; 
      if (item.likes > 0) likesCount.textContent = `${item.likes} Me gusta`; else likesCount.textContent = "S√© el primero en dar Like";
      card.appendChild(likesCount);

      const commentsSection = document.createElement("div"); commentsSection.className = "comments-section";
      if (isModal) { item.comments.forEach(c => appendComment(commentsSection, c)); } 
      else {
          const total = item.comments.length; const LIMIT = 3;
          if (total > LIMIT) {
             const btnMore = document.createElement("button"); btnMore.className = "view-more-comments"; btnMore.textContent = `Ver los ${total} comentarios...`;
             const hiddenDiv = document.createElement("div"); hiddenDiv.className = "hidden-comments";
             const hiddenComments = item.comments.slice(0, total - LIMIT); hiddenComments.forEach(c => appendComment(hiddenDiv, c));
             const visibleComments = item.comments.slice(total - LIMIT, total);
             commentsSection.appendChild(btnMore); commentsSection.appendChild(hiddenDiv); visibleComments.forEach(c => appendComment(commentsSection, c));
             btnMore.onclick = () => { hiddenDiv.style.display = "block"; btnMore.style.display = "none"; };
          } else { item.comments.forEach(c => appendComment(commentsSection, c)); }
      }
      card.appendChild(commentsSection);

      const addCommentBox = document.createElement("div"); addCommentBox.className = "add-comment-box";
      const inputComment = document.createElement("input"); inputComment.className = "comment-input"; inputComment.placeholder = `Comenta como ${currentUser}...`;
      const postBtn = document.createElement("button"); postBtn.className = "post-btn"; postBtn.textContent = "Publicar";
      postBtn.onclick = () => {
          const text = inputComment.value.trim(); if(!text) return;
          const fullText = `${currentUser}: ${text}`; const now = new Date(); 
          appendComment(commentsSection, {text: fullText, time: now});
          const globalItem = itemsGlobal.find(i => i.id === item.id);
          if(globalItem) { if(!globalItem.comments) globalItem.comments = []; globalItem.comments.push({text: fullText, time: now}); }
          inputComment.value = ""; comment(item.id, currentUser, text);
          if(isModal) commentsSection.scrollTop = commentsSection.scrollHeight;
      };
      addCommentBox.appendChild(inputComment); addCommentBox.appendChild(postBtn); card.appendChild(addCommentBox);
      return card;
}

function appendComment(container, c) {
    if(!c.text) return; const timeStr = timeAgo(c.time); const p = document.createElement("div"); p.className = "comment";
    let contentHtml = "";
    if(c.text.includes(":")){ const parts = c.text.split(":"); const name = parts[0]; const msg = parts.slice(1).join(":"); contentHtml = `<span><strong>${name}:</strong> ${msg}</span>`; } 
    else { contentHtml = `<span><strong>Invitado:</strong> ${c.text}</span>`; }
    p.innerHTML = `<div class="comment-text">${contentHtml}</div><div class="comment-time">${timeStr}</div>`; container.appendChild(p);
}

// BUCLE DE ACTUALIZACI√ìN: Ahora SIEMPRE carga por detr√°s para que la presentaci√≥n tenga fotos frescas
loadGallery();
setInterval(() => { loadGallery(true); }, 15000);

input.onchange = async () => {
  const file = input.files[0]; if(!file) return;
  showToast("Procesando foto... ‚è≥");
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
       const canvas = document.createElement("canvas"); const MAX_SIZE = 2048; let w = img.width; let h = img.height;
       if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } } else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
       canvas.width = w; canvas.height = h; const ctx = canvas.getContext("2d"); ctx.drawImage(img, 0, 0, w, h);
       const base64 = canvas.toDataURL("image/jpeg", 0.9).split(",")[1];
       showToast("Subiendo foto... üöÄ");
       const payload = { action: "upload", file: base64, name: file.name || "foto.jpg", type: "image/jpeg", uploader: currentUser || "An√≥nimo" };
       fetch(API, { method: "POST", body: JSON.stringify(payload), headers: { "Content-Type": "text/plain" } })
       .then(res => res.text()).then(txt => { showToast("¬°Foto subida correctamente! üéâ"); input.value = ""; loadGallery(); })
       .catch((err) => { console.error(err); showToast("Error al subir. Intenta de nuevo."); });
    }; img.src = e.target.result;
  }; reader.readAsDataURL(file);
};

async function handleLike(event, id, countElementId, mediaContainer) {
  const btn = event.currentTarget; const countEl = document.getElementById(countElementId); let current = 0;
  if(countEl && countEl.textContent !== "S√© el primero en dar Like") current = parseInt(countEl.textContent);
  let myLikes = []; try { myLikes = JSON.parse(localStorage.getItem("whynot_likes") || "[]"); } catch(e){}
  const globalItem = itemsGlobal.find(i => i.id === id);
  if (btn.classList.contains("liked")) {
      btn.classList.remove("liked"); let newVal = Math.max(0, current - 1);
      if(newVal === 0) { if(countEl) countEl.textContent = "S√© el primero en dar Like"; } else { if(countEl) countEl.textContent = `${newVal} Me gusta`; }
      myLikes = myLikes.filter(itemId => itemId !== id); localStorage.setItem("whynot_likes", JSON.stringify(myLikes));
      if(globalItem) globalItem.likes = newVal;
      await fetch(API, {method: "POST", body: JSON.stringify({action: "unlike", id: id}), headers: {"Content-Type": "text/plain"}});
  } else {
      btn.classList.add("liked"); showBigHeart(mediaContainer); let newVal = current + 1;
      if(countEl) countEl.textContent = `${newVal} Me gusta`;
      if (!myLikes.includes(id)) { myLikes.push(id); localStorage.setItem("whynot_likes", JSON.stringify(myLikes)); }
      if(globalItem) globalItem.likes = newVal;
      await fetch(API, {method: "POST", body: JSON.stringify({action: "like", id: id}), headers: {"Content-Type": "text/plain"}});
  }
}

function showBigHeart(container) {
    if(!container) return; if(container.querySelector('.big-heart')) return; 
    const heart = document.createElement("div"); heart.className = "big-heart";
    heart.innerHTML = `<svg viewBox="0 0 24 24" fill="#ed4956"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
    container.appendChild(heart); setTimeout(() => heart.remove(), 1000);
}

async function comment(id, name, text){
  if(!text) return; const displayName = name.trim() || "An√≥nimo";
  await fetch(API, { method: "POST", body: JSON.stringify({action: "comment", id, text: `${displayName}: ${text}`}), headers: {"Content-Type": "text/plain"} });
}

function showToast(msg) { toast.textContent = msg || "¬°Notificaci√≥n!"; toast.classList.add("show"); setTimeout(() => toast.classList.remove("show"), 3000); }

async function shareImage(event, url) {
  const btn = event.currentTarget; if(btn.disabled) return; btn.style.opacity = "0.5"; showToast("Preparando foto original... üì≤"); btn.disabled = true;
  try {
    let id = ""; if (url.includes("id=")) { id = url.split("id=")[1].split("&")[0]; }
    const fetchUrl = `https://lh3.googleusercontent.com/d/${id}=s0`;
    const response = await fetch(fetchUrl); if (!response.ok) throw new Error("Error red");
    const blob = await response.blob(); const file = new File([blob], `boda_whynot_${id}.jpg`, { type: "image/jpeg" });
    if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: "Boda WhyNot!?", text: "¬°Mira este recuerdo! üòç" }); } else { throw new Error("No soporta archivos"); }
  } catch (error) {
    if (navigator.share) { navigator.share({ title: "Boda WhyNot!?", text: "¬°Mira esta foto! üòç " + url }); } else { window.open(url, "_blank"); }
  } finally { setTimeout(() => { btn.disabled = false; btn.style.opacity = "1"; }, 2000); }
}

function openSimpleModal(url){
  isSlideshowActive = false; modal.style.display = "flex"; modalContent.innerHTML = "";
  const img = document.createElement("img"); img.className = "simple-img"; img.src = url; modalContent.appendChild(img);
}

function openFullPost(item) {
    isSlideshowActive = false; modal.style.display = "flex"; modalContent.innerHTML = "";
    let myLikes = []; try { myLikes = JSON.parse(localStorage.getItem("whynot_likes") || "[]"); } catch(e) {}
    const card = createCardElement(item, myLikes, true); modalContent.appendChild(card);
}

function closeModalDirect(event) {
    if (isSlideshowActive) { stopSlideshow(); } 
    else if (event.target.id === "modal" || event.target.id === "modal-content") { stopSlideshow(); }
}

function stopSlideshow(){ slideCounter = 0; clearInterval(slideInterval); isSlideshowActive = false; modal.style.display = "none"; modalContent.innerHTML = ""; }

function startSlideshow(){
  if(!itemsGlobal.length) return alert("A√∫n no hay fotos");
  isSlideshowActive = true; slideCounter = 0; modal.style.display = "flex";
  changeRandomSlide(); slideInterval = setInterval(() => { changeRandomSlide(); }, 6000);
}

// üí• MAGIA 2: L√ìGICA DE PRESENTACI√ìN + RANKING √âPICO
function changeRandomSlide(){
  if(itemsGlobal.length === 0) return;
  slideCounter++;

  // Cada 6 fotos, ¬°BOOM! Pantallazo del Top 3
  if (slideCounter % 6 === 0) {
      const fotosRanking = [...itemsGlobal].filter(i => !i.url.includes("/vid.mp4")).sort((a, b) => b.likes - a.likes).slice(0, 3);
      if(fotosRanking.length >= 3) {
          showRankingSlide(fotosRanking);
          return;
      }
  }

  // Si no toca Ranking, foto aleatoria normal (absorbiendo las nuevas subidas)
  const randomIndex = Math.floor(Math.random() * itemsGlobal.length);
  const item = itemsGlobal[randomIndex];
  if(item.url.includes("/vid.mp4")) { changeRandomSlide(); return; }
  
  const uploader = item.uploader || "Invitado";
  const likes = item.likes || 0;

  modalContent.innerHTML = `
    <div class="slideshow-wrapper">
       <div class="slideshow-brand-top">Boda Jose & Irene</div>
       <img class="slideshow-img" src="${item.url}">
       
       <div class="slideshow-info">
           <span>Por <strong>${uploader}</strong></span> ‚Ä¢ 
           <div class="icon-block">
              <svg class="slideshow-heart" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> 
              ${likes}
           </div>
       </div>

       <div class="slideshow-brand-bottom">WhyNot?!?!</div>
    </div>
  `;
}

// üí• MAGIA 3: CONSTRUCCI√ìN VISUAL DEL PODIO
function showRankingSlide(top3) {
    // top3[0] es el 1¬∫, top3[1] es el 2¬∫, top3[2] es el 3¬∫
    modalContent.innerHTML = `
      <div class="ranking-wrapper">
         <div class="ranking-title">üèÜ Top Fotos WhyNot?!?! üèÜ</div>
         
         <div class="podium">
            <div class="podium-item rank-2">
               <div class="podium-ring silver"><img class="podium-img" src="${getOptimizedThumbnailUrl(top3[1].url)}"></div>
               <div class="podium-name">${top3[1].uploader || "Invitado"}</div>
               <div class="podium-likes"><svg style="width:20px;fill:#ed4956" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> ${top3[1].likes}</div>
            </div>
            
            <div class="podium-item rank-1">
               <div class="podium-ring gold"><img class="podium-img" src="${getOptimizedThumbnailUrl(top3[0].url)}"></div>
               <div class="podium-name">${top3[0].uploader || "Invitado"}</div>
               <div class="podium-likes"><svg style="width:24px;fill:#ed4956" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> ${top3[0].likes}</div>
            </div>

            <div class="podium-item rank-3">
               <div class="podium-ring bronze"><img class="podium-img" src="${getOptimizedThumbnailUrl(top3[2].url)}"></div>
               <div class="podium-name">${top3[2].uploader || "Invitado"}</div>
               <div class="podium-likes"><svg style="width:20px;fill:#ed4956" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> ${top3[2].likes}</div>
            </div>
         </div>
      </div>
    `;
}
</script>

</body>
</html>
